<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Canny Edge Detection Side by Side</title>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      height: 100vh;
      background: #f0f0f0;
    }
    video, canvas {
      border: 1px solid #444;
    }
    #canvasFrame {
      display: none;
    }
  </style>
</head>
<body>
  <video id="video" controls muted>
    <source src="myvideo.mp4" type="video/mp4">
  </video>
  <canvas id="canvasFrame"></canvas>
  <canvas id="canvasOutput"></canvas>

  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
  <script>
    let video = document.getElementById("video");

    function onOpenCvReady() {
      cv['onRuntimeInitialized'] = () => {
        video.addEventListener("loadedmetadata", () => {
          // Thiết lập lại canvas đúng kích thước
          const width = video.videoWidth;
          const height = video.videoHeight;

          const canvasFrame = document.getElementById("canvasFrame");
          const ctxFrame = canvasFrame.getContext("2d");
          const canvasOutput = document.getElementById("canvasOutput");

          canvasFrame.width = width;
          canvasFrame.height = height;
          canvasOutput.width = width;
          canvasOutput.height = height;

          const src = new cv.Mat(height, width, cv.CV_8UC4);
          const gray = new cv.Mat();
          const edges = new cv.Mat();

          function processFrame() {
            if (video.paused || video.ended) {
              src.delete(); gray.delete(); edges.delete();
              return;
            }

            ctxFrame.drawImage(video, 0, 0, width, height);
            let imageData = ctxFrame.getImageData(0, 0, width, height);
            src.data.set(imageData.data);

            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
            cv.Canny(gray, edges, 50, 150);
            cv.imshow("canvasOutput", edges);

            requestAnimationFrame(processFrame);
          }

          video.addEventListener("play", () => {
            requestAnimationFrame(processFrame);
          });
        });
      };
    }
  </script>
  <script onload="onOpenCvReady()" async src="https://docs.opencv.org/4.x/opencv.js"></script>
</body>
</html>
